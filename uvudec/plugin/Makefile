# Plugin recursive build makefile
# UVNet Universal Decompiler (uvudec)
# Copyright 2010 John McMaster <JohnDMcMaster@gmail.com>
# Licensed under terms of the three clause BSD license, see LICENSE for details

ALL_TARGETS += recurse
CLEAN_DEPS+=cleanRecurse
ROOT_DIR=..
include Makefile.mk

RECURSIVE_MAKEFILE=Makefile.recurse
recurse:
	echo -n '' > $(RECURSIVE_MAKEFILE)
	echo '# This file is automatically generated, do not edit it!' >> $(RECURSIVE_MAKEFILE)
	echo '' >> $(RECURSIVE_MAKEFILE)

	echo -n 'doRecursiveAll: ' >> $(RECURSIVE_MAKEFILE)
	for subMakefile in $(shell find -mindepth 2 -maxdepth 2 -name 'Makefile'); do \
		DIR=$$(basename $$(dirname $${subMakefile})) ; \
		echo -n " $$DIR" >>$(RECURSIVE_MAKEFILE) ; \
	done;
	echo '' >> $(RECURSIVE_MAKEFILE)
	echo -e '\t@(echo doRecursiveAll: done)' >> $(RECURSIVE_MAKEFILE)
	echo '' >> $(RECURSIVE_MAKEFILE)

	for subMakefile in $(shell find -mindepth 2 -maxdepth 2 -name 'Makefile'); do \
		DIR=$$(basename $$(dirname $${subMakefile})) ; \
		echo "$$DIR:" >>$(RECURSIVE_MAKEFILE) ; \
		echo -e "\tcd $$DIR && $(MAKE)" >>$(RECURSIVE_MAKEFILE) ; \
		echo '' >> $(RECURSIVE_MAKEFILE) ; \
	done;

	echo -n '.PHONY: ' >> $(RECURSIVE_MAKEFILE)
	for subMakefile in $(shell find -mindepth 2 -maxdepth 2 -name 'Makefile'); do \
		DIR=$$(basename $$(dirname $${subMakefile})) ; \
		echo -n " $$DIR" >>$(RECURSIVE_MAKEFILE) ; \
	done;
	echo '' >> $(RECURSIVE_MAKEFILE)

	echo '' >> $(RECURSIVE_MAKEFILE)
	
	$(MAKE) doRecursiveAll RECURSING=Y

ifeq ($(RECURSING),Y)

# FIXME: this dep shouldn't exit, make functionality generic
uvdbfd: uvdflirt

include $(RECURSIVE_MAKEFILE)
endif


cleanRecurse:
	for subMakefile in $(shell find -mindepth 2 -maxdepth 2 -name 'Makefile'); do \
		DIR=$$(dirname $${subMakefile}) ; \
		(cd $$DIR && $(MAKE) clean) ||exit 1 ; \
	done;

